import base64
from datetime import datetime
import logging
import os
import asyncio
import re
import uuid
from typing import Optional, Dict, Any, List, Callable, Awaitable
import httpx
from bs4 import BeautifulSoup

from gigachat import GigaChat
from gigachat.models import Chat, Messages, MessagesRole
from gigachat.exceptions import ResponseError

from config import Config, config
from utils.rate_limiter import get_global_limiter
from utils.generation_queue import get_generation_queue, GenerationType


logger = logging.getLogger(__name__)

async def _has_links(user_idea):
    """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è —Å—Å—ã–ª–æ–∫ –≤ –∏–¥–µ–∏(—Ç–µ–∫—Å—Ç–µ) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    return any(word in user_idea.lower() for word in ['http://', 'https://', 'www.', '.ru', '.com', '—Å—Å—ã–ª–∫–∞'])


class GigaChatService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å GigaChat API"""

    def __init__(self, config: Config):
        self.credentials = config.GIGACHAT_CREDENTIALS # –ö–ª—é—á –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        self.verify_ssl_certs = False

    async def _agenerate(self, prompt: str, system_prompt: str = "", temperature: float = 0.7, max_tokens: int = 512,
                         credentials: str = None, on_start_callback: Optional[Callable[[], Awaitable[None]]] = None) -> tuple[str, int]:
        """–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–µ—Ç–æ–¥ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ GigaChat —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –æ—á–µ—Ä–µ–¥–∏"""
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∑–∞–º—ã–∫–∞–Ω–∏–∏
        prompt_value = prompt
        system_prompt_value = system_prompt or "–¢—ã ‚Äî –ø–æ–ª–µ–∑–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç."
        temperature_value = temperature
        max_tokens_value = max_tokens
        used_credentials = credentials if credentials else self.credentials
        
        async def _generate_internal():
            try:
                # –ü–æ–ª—É—á–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç–µ—Ä
                limiter = get_global_limiter()
                
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–∏–º–∏—Ç–µ—Ä –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
                async with limiter:
                    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                    messages = [
                        Messages(role=MessagesRole.SYSTEM, content=system_prompt_value),
                        Messages(role=MessagesRole.USER, content=prompt_value),
                    ]

                    chat = Chat(messages=messages, temperature=temperature_value, max_tokens=max_tokens_value)

                    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
                    async with GigaChat(credentials=used_credentials, verify_ssl_certs=self.verify_ssl_certs) as giga:
                        response = await giga.achat(payload=chat)

                    if response.choices and len(response.choices) > 0:
                        return response.choices[0].message.content.strip()
                    return "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç."
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ GigaChat: {e}", exc_info=True)
                raise
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ –æ—á–µ—Ä–µ–¥—å
        queue = get_generation_queue()
        result, position = await queue.add_task(GenerationType.TEXT, _generate_internal, on_start_callback=on_start_callback)
        return result, position

    async def validate_credentials(self, credentials: str) -> tuple[bool, str]:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å API-–∫–ª—é—á–∞ GigaChat"""
        try:
            # –ü—ã—Ç–∞–µ–º—Å—è —Å–¥–µ–ª–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–ª—é—á–∞
            test_prompt = "–ü—Ä–∏–≤–µ—Ç, –æ—Ç–≤–µ—Ç—å –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º: OK"
            messages = [Messages(role=MessagesRole.USER, content=test_prompt)]
            chat = Chat(messages=messages, max_tokens=10)
            
            async with GigaChat(credentials=credentials, verify_ssl_certs=self.verify_ssl_certs) as giga:
                response = await giga.achat(payload=chat)
            
            if response and response.choices:
                return True, "–ö–ª—é—á –≤–∞–ª–∏–¥–µ–Ω"
            return False, "–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç API"
            
        except Exception as e:
            error_msg = str(e).lower()
            if "auth" in error_msg or "unauthorized" in error_msg or "authorization" in error_msg:
                return False, "–ù–µ–≤–µ—Ä–Ω—ã–π API-–∫–ª—é—á"
            elif "quota" in error_msg or "limit" in error_msg or "exceeded" in error_msg:
                return False, "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"
            else:
                return False, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–ª—é—á–∞: {str(e)}"

    async def get_token_info(self, credentials: str) -> tuple[bool, str]:
        """–ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Ç–æ–∫–µ–Ω–∞—Ö"""
        try:

            messages = [Messages(role=MessagesRole.USER, content="–ü—Ä–∏–≤–µ—Ç")]
            chat = Chat(messages=messages, max_tokens=5)

            async with GigaChat(credentials=credentials, verify_ssl_certs=self.verify_ssl_certs) as giga:
                response = await giga.achat(payload=chat)

            if response and response.usage:

                total_tokens = await self.get_balance(giga.token)
                logger.info(f"–û—Å—Ç–∞–ª–æ—Å—å —Ç–æ–∫–µ–Ω–æ–≤: {total_tokens[1]}")
                return True, f"–¢–æ–∫–µ–Ω—ã –¥–æ—Å—Ç—É–ø–Ω—ã. –û—Å—Ç–∞–ª–æ—Å—å: {total_tokens[1]} —Ç–æ–∫–µ–Ω–æ–≤!"
            else:
                return True, "–¢–æ–∫–µ–Ω—ã –¥–æ—Å—Ç—É–ø–Ω—ã. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Å—Ç–∞—Ç–∫–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ API."

        except Exception as e:
            error_msg = str(e).lower()
            if "quota" in error_msg or "limit" in error_msg or "exceeded" in error_msg:
                return False, "–õ–∏–º–∏—Ç —Ç–æ–∫–µ–Ω–æ–≤ –∏—Å—á–µ—Ä–ø–∞–Ω"
            elif "auth" in error_msg or "unauthorized" in error_msg:
                return False, "–ù–µ–≤–µ—Ä–Ω—ã–π API-–∫–ª—é—á"
            else:
                return False, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: {str(e)}"

    async def generate_free_text(
            self,
            user_idea: str,
            nko_data: Optional[Dict[str, Any]] = None,
            include_image: bool = False,
            user_api_key: Optional[str] = None,
            on_start_callback: Optional[Callable[[], Awaitable[None]]] = None
    ) -> tuple[str, int]:
        has_links = await _has_links(user_idea)

        prompt_parts = [
            "–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –ù–ö–û. –ü–µ—Ä–µ–ø–∏—à–∏ –∏–¥–µ—é –≤ –∑–∞–∫–æ–Ω—á–µ–Ω–Ω—ã–π, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –ø—Ä–∏–∑—ã–≤–Ω—ã–π –ø–æ—Å—Ç.",
            f"–ò–¥–µ—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_idea}"
        ]

        if nko_data:
            nko_info = "–ö–æ–Ω—Ç–µ–∫—Å—Ç –ù–ö–û:\n"
            if nko_data.name:
                nko_info += f"–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ: {nko_data.name}\n"
            if nko_data.description:
                nko_info += f"–û–ø–∏—Å–∞–Ω–∏–µ: {nko_data.description}\n"
            if nko_data.activities:
                nko_info += f"–§–æ—Ä–º—ã –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: {nko_data.activities}\n"
            if nko_info.strip() != "–ö–æ–Ω—Ç–µ–∫—Å—Ç –ù–ö–û:":
                prompt_parts.append(nko_info)

        if include_image:
            prompt_parts.append(
                "–ö –ø–æ—Å—Ç—É –±—É–¥–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ‚Äî —Å–¥–µ–ª–∞–π —Ç–µ–∫—Å—Ç –∫–æ—Ä–æ—á–µ, —è—Ä—á–µ –∏ –æ—Å—Ç–∞–≤—å –º–µ—Å—Ç–æ –¥–ª—è –≤–∏–∑—É–∞–ª–∞.")

        prompt_parts.append(
            "–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–æ—Å—Ç—É:\n"
            "1. –ù–∞—á–Ω–∏ —Å —Ü–µ–ø–ª—è—é—â–µ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞ (–æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞), –≤—ã–¥–µ–ª–∏ –µ–≥–æ –∂–∏—Ä–Ω—ã–º —á–µ—Ä–µ–∑ **–∑–≤—ë–∑–¥–æ—á–∫–∏**.\n"
            "2. –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç ‚Äî —Ç—ë–ø–ª—ã–π, –∂–∏–≤–æ–π, –±–µ–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç–∞. –ò—Å–ø–æ–ª—å–∑—É–π –Ω–µ –±–æ–ª–µ–µ 2‚Äì3 —ç–º–æ–¥–∑–∏.\n"
            "3. –î–æ–±–∞–≤—å –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é (–ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å, —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å, –ø—Ä–∏–π—Ç–∏ –∏ —Ç.–ø.).\n"
            f"4. {'–í–∫–ª—é—á–∏ —Å—Å—ã–ª–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ –≤ –∏–¥–µ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.' if has_links else '–ù–ò –í –ö–û–ï–ú –°–õ–£–ß–ê–ï –ù–ï –î–û–ë–ê–í–õ–Ø–ô –°–°–´–õ–ö–ò, –ï–°–õ–ò –ò–• –ù–ï –ë–´–õ–û –í –ò–î–ï–ï. –ù–ï –ü–†–ò–î–£–ú–´–í–ê–ô [—Å–∞–π—Ç], [–ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å], [–¥–æ–Ω–∞—Ç] –ò–õ–ò –ê–ù–ê–õ–û–ì–ò–ß–ù–´–ï.'}\n"
            "5. –í —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ ‚Äî –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π ‚Äî –¥–æ–±–∞–≤—å 5‚Äì7 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ö–µ—à—Ç–µ–≥–æ–≤ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ–±–µ–ª—ã –∏ –æ–ø–µ—á–∞—Ç–∫–∏.\n"
            "6. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –ø–æ—è—Å–Ω–µ–Ω–∏–π –≤—Ä–æ–¥–µ '–í–æ—Ç –ø–æ—Å—Ç:' ‚Äî –≤–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —Å–∞–º –ø–æ—Å—Ç.\n"
            "7. –§–æ—Ä–º–∞—Ç: Markdown (—Ä–∞–∑—Ä–µ—à–µ–Ω–æ **–∂–∏—Ä–Ω—ã–π**; —Å—Å—ã–ª–∫–∏ [—Ç–µ–∫—Å—Ç](url) –î–û–ë–ê–í–õ–Ø–ô –¢–û–õ–¨–ö–û –ï–°–õ–ò –ë–´–õ–ò –í –ò–î–ï–ï)."
        )

        prompt = "\n\n".join(prompt_parts)
        system = (
            "–í–ê–ñ–ù–û: –¢–´ –°–¢–†–û–ì–û –ó–ê–ü–†–ï–©–ê–ï–®–¨ –°–ï–ë–ï –î–û–ë–ê–í–õ–Ø–¢–¨ –õ–Æ–ë–´–ï –°–°–´–õ–ö–ò, –ï–°–õ–ò –ò–• –ù–ï –ë–´–õ–û –í –ò–î–ï–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø. "
            "–¢—ã ‚Äî –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä. –ü–∏—à–∏ –∂–∏–≤–æ, —Ç–µ–ø–ª–æ, –Ω–æ –±–µ–∑ –ø—Ä–∏–¥—É–º–∞–Ω–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤. "
            "–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–ª —Å—Å—ã–ª–∫–∏ ‚Äî –ù–ï –í–°–¢–ê–í–õ–Ø–ô –ò–• –ù–ò –ü–†–ò –ö–ê–ö–ò–• –û–ë–°–¢–û–Ø–¢–ï–õ–¨–°–¢–í–ê–•."
        )

        result, position = await self._agenerate(prompt, system, temperature=0.7, credentials=user_api_key, on_start_callback=on_start_callback)

        return result.strip(), position


    async def get_balance(self, credentials: str = None) -> tuple[bool, str]:
        """–ü–æ–ª—É—á–∞–µ—Ç –æ—Å—Ç–∞—Ç–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤ —á–µ—Ä–µ–∑ API /balance."""
        used_credentials = credentials or self.credentials
        if not used_credentials:
            return False, "API-–∫–ª—é—á –Ω–µ —É–∫–∞–∑–∞–Ω"

        url = "https://gigachat.devices.sberbank.ru/api/v1/balance"
        headers = {
            "Authorization": f"Bearer {used_credentials}",
            "X-Request-ID": "req-" + asyncio.current_task().get_name()[-8:],
            "X-Session-ID": "sess-" + asyncio.current_task().get_name()[-8:],
        }

        try:
            async with httpx.AsyncClient(verify=False) as client:
                response = await client.get(url, headers=headers, timeout=10.0)

            if response.status_code == 200:
                data = response.json()
                balance_info = data.get("balance", [])
                if not balance_info:
                    return True, "–Ω–µ –Ω–∞–π–¥–µ–Ω—ã –º–æ–¥–µ–ª–∏!"

                # –ò—â–µ–º –º–æ–¥–µ–ª—å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ—ë –æ—Å—Ç–∞—Ç–æ–∫
                for item in balance_info:
                    if item.get("usage") == "GigaChat":
                        balance_value = str(item.get("value", 0))
                        return True, balance_value

                # –ï—Å–ª–∏ –º–æ–¥–µ–ª—å GigaChat –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
                return True, "0"

            elif response.status_code == 401:
                return False, "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: –Ω–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏–π —Ç–æ–∫–µ–Ω"
            elif response.status_code == 403:
                return False, "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω: –≤–æ–∑–º–æ–∂–Ω–æ, –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ pay-as-you-go —Ç–∞—Ä–∏—Ñ"
            else:
                return False, f"–û—à–∏–±–∫–∞ {response.status_code}: {response.text}"

        except httpx.TimeoutException:
            return False, "–¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ API"
        except httpx.RequestError as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –±–∞–ª–∞–Ω—Å–∞: {e}")
            return False, f"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: {str(e)}"
        except Exception as e:
            logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –±–∞–ª–∞–Ω—Å–∞: {e}")
            return False, f"–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞: {str(e)}"


    async def generate_structured_post(
        self,
        event_info: Dict[str, str],
        nko_data: Optional[Dict[str, Any]] = None,
        user_api_key: Optional[str] = None
    ) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (—Å–æ–±—ã—Ç–∏–µ, –¥–∞—Ç–∞, –º–µ—Å—Ç–æ –∏ —Ç.–¥.)"""
        
        has_links = await _has_links(str(event_info))
        if nko_data:
            has_links = has_links or await _has_links(str(nko_data))

        prompt_parts = [
            "–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –ù–ö–û. –°–æ–∑–¥–∞–π –ø–æ—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:",
        ]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–±—ã—Ç–∏–∏
        prompt_parts.append("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–±—ã—Ç–∏–∏:")
        for k, v in event_info.items():
            prompt_parts.append(f"{k.capitalize()}: {v}")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ù–ö–û
        if nko_data:
            nko_info_parts = []
            if nko_data.name:
                nko_info_parts.append(f"–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ: {nko_data.name}")
            if nko_data.description:
                nko_info_parts.append(f"–û–ø–∏—Å–∞–Ω–∏–µ: {nko_data.description}")
            if nko_data.activities:
                nko_info_parts.append(f"–§–æ—Ä–º—ã –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: {nko_data.activities}")
            if nko_info_parts:
                prompt_parts.append("\n–ö–æ–Ω—Ç–µ–∫—Å—Ç –ù–ö–û:")
                prompt_parts.extend(nko_info_parts)
        
        prompt_parts.append(
            "\n–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–æ—Å—Ç—É:\n"
            "1. –ù–∞—á–Ω–∏ —Å —Ü–µ–ø–ª—è—é—â–µ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞ (–æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞), –≤—ã–¥–µ–ª–∏ –µ–≥–æ –∂–∏—Ä–Ω—ã–º —á–µ—Ä–µ–∑ **–∑–≤—ë–∑–¥–æ—á–∫–∏**.\n"
            "2. –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç ‚Äî —Ç—ë–ø–ª—ã–π, –∂–∏–≤–æ–π, –±–µ–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç–∞. –ò—Å–ø–æ–ª—å–∑—É–π –Ω–µ –±–æ–ª–µ–µ 2‚Äì3 —ç–º–æ–¥–∑–∏.\n"
            "3. –î–æ–±–∞–≤—å –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é (–ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å, —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å, –ø—Ä–∏–π—Ç–∏ –∏ —Ç.–ø.).\n"
            f"4. {'–í–∫–ª—é—á–∏ —Å—Å—ã–ª–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ –≤ –¥–∞–Ω–Ω—ã—Ö.' if has_links else '–ù–ò –í –ö–û–ï–ú –°–õ–£–ß–ê–ï –ù–ï –î–û–ë–ê–í–õ–Ø–ô –°–°–´–õ–ö–ò, –ï–°–õ–ò –ò–• –ù–ï –ë–´–õ–û –í –î–ê–ù–ù–´–•. –ù–ï –ü–†–ò–î–£–ú–´–í–ê–ô [—Å–∞–π—Ç], [–ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å], [–¥–æ–Ω–∞—Ç] –ò–õ–ò –ê–ù–ê–õ–û–ì–ò–ß–ù–´–ï.'}\n"
            "5. –í —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ ‚Äî –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π ‚Äî –¥–æ–±–∞–≤—å 5‚Äì7 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ö–µ—à—Ç–µ–≥–æ–≤ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ–±–µ–ª—ã –∏ –æ–ø–µ—á–∞—Ç–∫–∏.\n"
            "6. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –ø–æ—è—Å–Ω–µ–Ω–∏–π –≤—Ä–æ–¥–µ '–í–æ—Ç –ø–æ—Å—Ç:' ‚Äî –≤–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —Å–∞–º –ø–æ—Å—Ç.\n"
            "7. –§–æ—Ä–º–∞—Ç: Markdown (—Ä–∞–∑—Ä–µ—à–µ–Ω–æ **–∂–∏—Ä–Ω—ã–π**; —Å—Å—ã–ª–∫–∏ [—Ç–µ–∫—Å—Ç](url) –î–û–ë–ê–í–õ–Ø–ô –¢–û–õ–¨–ö–û –ï–°–õ–ò –ë–´–õ–ò –í –î–ê–ù–ù–´–•)."
        )

        prompt = "\n\n".join(prompt_parts)
        system = (
            "–í–ê–ñ–ù–û: –¢–´ –°–¢–†–û–ì–û –ó–ê–ü–†–ï–©–ê–ï–®–¨ –°–ï–ë–ï –î–û–ë–ê–í–õ–Ø–¢–¨ –õ–Æ–ë–´–ï –°–°–´–õ–ö–ò, –ï–°–õ–ò –ò–• –ù–ï –ë–´–õ–û –í –î–ê–ù–ù–´–•. "
            "–¢—ã ‚Äî –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä. –ü–∏—à–∏ –∂–∏–≤–æ, —Ç–µ–ø–ª–æ, –Ω–æ –±–µ–∑ –ø—Ä–∏–¥—É–º–∞–Ω–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤. "
            "–ï—Å–ª–∏ –≤ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –±—ã–ª–æ —Å—Å—ã–ª–æ–∫ ‚Äî –ù–ï –í–°–¢–ê–í–õ–Ø–ô –ò–• –ù–ò –ü–†–ò –ö–ê–ö–ò–• –û–ë–°–¢–û–Ø–¢–ï–õ–¨–°–¢–í–ê–•."
        )

        result, _ = await self._agenerate(prompt, system, temperature=0.7, credentials=user_api_key)
        return result.strip()

    async def generate_text_from_examples(
            self,
            example_posts: List[str],
            new_idea: str,
            user_api_key: Optional[str] = None,
            nko_data: Optional[Dict[str, Any]] = None,
    ) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞ –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ —Å—Ç–∏–ª—è –¥—Ä—É–≥–∏—Ö –ø–∞–±–ª–∏–∫–æ–≤"""

        has_links = await _has_links(new_idea)

        prompt_parts = [
            "–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å—Ç–∏–ª—é –∏ –ø–æ–¥–∞—á–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö. –ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥–µ–Ω—ã —Ä–µ–∞–ª—å–Ω—ã–µ –ø–æ—Å—Ç—ã –∏–∑ –ø–∞–±–ª–∏–∫–æ–≤ –ù–ö–û, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –¥–æ–ª–∂–µ–Ω –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å: –∏—Ö —Å—Ç–∏–ª—å, —Ç–æ–Ω, —Å—Ç—Ä—É–∫—Ç—É—Ä—É, —Ä–∏—Ç–º, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —ç–º–æ–¥–∑–∏, –∑–∞–≥–æ–ª–æ–≤–∫–∏, –ø—Ä–∏–∑—ã–≤—ã –∫ –¥–µ–π—Å—Ç–≤–∏—é –∏ —Ö–µ—à—Ç–µ–≥–∏.\n"
            "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–µ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—Å–∞—Ç—å –ø–æ—Ö–æ–∂–∏–π –ø–æ—Å—Ç, –∞ –ü–û–õ–ù–û–°–¢–¨–Æ –í–û–ü–õ–û–¢–ò–¢–¨ —ç—Ç–æ—Ç —Å—Ç–∏–ª—å."
        ]

        for i, ex in enumerate(example_posts, 1):
            prompt_parts.append(f"üìå –ü—Ä–∏–º–µ—Ä –ø–æ—Å—Ç–∞ {i}:\n{ex}")

        prompt_parts.append(
            f"\nüéØ –¢–µ–ø–µ—Ä—å, —Å–æ—Ö—Ä–∞–Ω—è—è –í–ï–°–¨ —Å—Ç–∏–ª—å —ç—Ç–∏—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π, –Ω–∞–ø–∏—à–∏ –Ω–æ–≤—ã–π –ø–æ—Å—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é —Ç–µ–º—É:\n{new_idea}"
        )

        if nko_data:
            prompt_parts.append(
                "\nüîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (–Ω–µ –¥–ª—è –ø—Ä—è–º–æ–≥–æ –≤–∫–ª—é—á–µ–Ω–∏—è, –∞ –¥–ª—è –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è):\n"
                f"‚Äî –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏: {nko_data.name or '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}\n"
                f"‚Äî –û–ø–∏—Å–∞–Ω–∏–µ: {nko_data.description or '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}\n"
                f"‚Äî –°—Ñ–µ—Ä–∞ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: {nko_data.activities or '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}"
            )

        prompt_parts.append(
            "\n\nüìù –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:"
            "\n1. **–ó–∞–≥–æ–ª–æ–≤–æ–∫** ‚Äî —Ü–µ–ø–ª—è—é—â–∏–π, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π, –≤ —Å—Ç–∏–ª–µ –ø—Ä–∏–º–µ—Ä–æ–≤. –í—ã–¥–µ–ª–∏ **–∂–∏—Ä–Ω—ã–º** —á–µ—Ä–µ–∑ `**–∑–≤—ë–∑–¥–æ—á–∫–∏**`."
            "\n2. **–¢–æ–Ω –∏ —Å—Ç–∏–ª—å** ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≤—Ç–æ—Ä—è–π —Å—Ç–∏–ª—å –ø—Ä–∏–º–µ—Ä–æ–≤: –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ –∂–µ –ø—Ä–∏—ë–º—ã (–ª–∏—á–Ω–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ, –≤–æ–ø—Ä–æ—Å—ã, –∫–æ—Ä–æ—Ç–∫–∏–µ –∞–±–∑–∞—Ü—ã, –∏—Ä–æ–Ω–∏—è, –¥—É—à–µ–≤–Ω–æ—Å—Ç—å –∏ —Ç.–¥.)."
            "\n3. **–≠–º–æ–¥–∑–∏** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π 1‚Äì3, –µ—Å–ª–∏ —ç—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∏–ª—é –ø—Ä–∏–º–µ—Ä–æ–≤. –ù–∏–∫–∞–∫–∏—Ö –ø–µ—Ä–µ–≥—Ä—É–∑–æ–∫."
            "\n4. **–ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é** ‚Äî –æ—Ä–≥–∞–Ω–∏—á–Ω—ã–π, –∫–∞–∫ –≤ –æ–±—Ä–∞–∑—Ü–∞—Ö: '–ø–æ–¥–¥–µ—Ä–∂–∏—Ç–µ', '—Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ', '–ø—Ä–∏—Ö–æ–¥–∏—Ç–µ', '–ø–æ–¥–µ–ª–∏—Ç–µ—Å—å' –∏ —Ç.–ø."
            f"\n5. **–°—Å—ã–ª–∫–∏** ‚Äî {'–í–∫–ª—é—á–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ [—Ç–µ–∫—Å—Ç](url), –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ —É–∫–∞–∑–∞–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.' if has_links else '–ù–ò –í –ö–û–ï–ú –°–õ–£–ß–ê–ï –ù–ï –î–û–ë–ê–í–õ–Ø–ô –°–°–´–õ–ö–ò. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π [—Å–∞–π—Ç], [–ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å], [–¥–æ–Ω–∞—Ç] ‚Äî –¥–∞–∂–µ –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ. –≠—Ç–æ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.'}"
            "\n6. **–•–µ—à—Ç–µ–≥–∏** ‚Äî –≤ –∫–æ–Ω—Ü–µ, –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π: 5‚Äì7 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö, –±–µ–∑ –æ–ø–µ—á–∞—Ç–æ–∫, –Ω–∞ —Ä—É—Å—Å–∫–æ–º. –ü—Ä–∏–º–µ—Ä: `#–ø–æ–º–æ—â—å–¥–µ—Ç—è–º #–≤–æ–ª–æ–Ω—Ç—ë—Ä—ã–ú—Å–∫ #–±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å`"
            "\n7. **–§–æ—Ä–º–∞—Ç** ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ—Å—Ç. –ù–µ –ø–∏—à–∏ –ø–æ—è—Å–Ω–µ–Ω–∏–π –≤—Ä–æ–¥–µ '–í–æ—Ç –≤–∞—à –ø–æ—Å—Ç:'. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –Ω—É–º–µ—Ä–∞—Ü–∏—é –∏–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ '–û—Ç–≤–µ—Ç'."
            "\n8. **–û—à–∏–±–∫–∏** ‚Äî –Ω–∏–∫–∞–∫–∏—Ö –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö, –ø—É–Ω–∫—Ç—É–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∏–ª–∏ —Å–º—ã—Å–ª–æ–≤—ã—Ö –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–µ–π. –ü–æ—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≥–æ—Ç–æ–≤ –∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏."
            "\n9. **–î–ª–∏–Ω–∞** ‚Äî –ø—Ä–∏–º–µ—Ä–Ω–æ –∫–∞–∫ –≤ –æ–±—Ä–∞–∑—Ü–∞—Ö. –ù–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ, –Ω–µ –∑–∞—Ç—è–Ω—É—Ç–æ."
        )

        prompt = "\n\n".join(prompt_parts)
        system = (
            "–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É –ù–ö–û. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å, –∞ –ö–û–ü–ò–†–û–í–ê–¢–¨ –°–¢–ò–õ–¨. "
            "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–∏–º–µ—Ä—ã: –∫–∞–∫ –æ–Ω–∏ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è, –∫–∞–∫ —Å—Ç—Ä–æ—è—Ç—Å—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –≥–¥–µ —Å—Ç–æ—è—Ç —ç–º–æ–¥–∑–∏, –∫–∞–∫ –∑–≤—É—á–∏—Ç –ø—Ä–∏–∑—ã–≤. "
            "–¢—ã –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ —Å—Ç–∏–ª—é –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–ª–∏—á–∏—Ç—å –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–≤. "
            f"–ó–ê–ü–†–ï–©–ï–ù–û –î–û–ë–ê–í–õ–Ø–¢–¨ –°–°–´–õ–ö–ò, –ï–°–õ–ò –ò–• –ù–ï –ë–´–õ–û –í –ü–†–ò–ú–ï–†–ê–• –ò–õ–ò –ò–î–ï–ï. –ü–û–í–¢–û–†–Ø–Æ: –ù–ò–ö–ê–ö–ò–• [—Å–∞–π—Ç], [–ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å], [–¥–æ–Ω–∞—Ç] ‚Äî –î–ê–ñ–ï –ï–°–õ–ò –ö–ê–ñ–ï–¢–°–Ø –£–ú–ï–°–¢–ù–´–ú. "
            "–ï—Å–ª–∏ –≤ –ø—Ä–∏–º–µ—Ä–∞—Ö –Ω–µ—Ç —Å—Å—ã–ª–æ–∫ ‚Äî —Ç—ã –∏—Ö –Ω–µ –≤—Å—Ç–∞–≤–ª—è–µ—à—å. –ù–∏–∫–∞–∫–∏—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π."
        )

        result, _ = await self._agenerate(prompt, system, temperature=0.7, credentials=user_api_key)
        return result.strip()


    async def edit_text(self, text: str, user_api_key: Optional[str] = None, on_start_callback: Optional[Callable[[], Awaitable[None]]] = None, user_wishes: Optional[str] = None) -> tuple[str, int]:
        """–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞"""

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç —Ç–æ–ª—å–∫–æ –∏–∑ –º—É—Å–æ—Ä–∞
        cleaned_text = text.strip()
        if not cleaned_text or len(cleaned_text) < 3 or re.match(r'^[\W\d]{1,3}$', cleaned_text):
            return text, 0  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

        has_links = await _has_links(text)

        prompt_parts = [
            "–¢—ã ‚Äî —Å—Ç—Ä–æ–≥–∏–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç, –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏ –∏ –¥–∞—Ç—å —á—ë—Ç–∫–∏–µ, –ø–æ–ª–µ–∑–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏. –ù–∏–∂–µ ‚Äî —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞."
        ]

        prompt_parts.append(f"**–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç:**\n{text}\n")
        
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑–∞–ª –ø–æ–∂–µ–ª–∞–Ω–∏—è, –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö
        if user_wishes:
            prompt_parts.append(f"**–ü–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:**\n{user_wishes}\n")

        prompt_parts.append(
            "**–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:**\n"
            "1. –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ–∫—Å—Ç –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö, –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö, –ø—É–Ω–∫—Ç—É–∞—Ü–∏–æ–Ω–Ω—ã—Ö, —Å—Ç–∏–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –∏ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫.\n"
            "2. –ò—Å–ø—Ä–∞–≤—å –≤—Å–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏.\n"
            "3. –£–ª—É—á—à–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ —á–∏—Ç–∞–µ–º–æ—Å—Ç—å, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ ‚Äî —Ä–∞–∑–±–µ–π –¥–ª–∏–Ω–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —É—Å—Ç—Ä–∞–Ω–∏ —Ç–∞–≤—Ç–æ–ª–æ–≥–∏–∏, —É–ø—Ä–æ—Å—Ç–∏ —Å–ª–æ–∂–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏.\n"
            "4. –°–æ—Ö—Ä–∞–Ω–∏ –æ—Å–Ω–æ–≤–Ω—É—é –º—ã—Å–ª—å, –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç—ã –∏ —Å—Ç–∏–ª—å –∞–≤—Ç–æ—Ä–∞. –ù–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.\n"
            "5. –°–æ—Ö—Ä–∞–Ω–∏ –í–°–Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∂–∏—Ä–Ω—ã–π, –∫—É—Ä—Å–∏–≤, —Å—Å—ã–ª–∫–∏ –∏ —Ç.–ø.) ‚Äî –Ω–µ —É–¥–∞–ª—è–π –∏ –Ω–µ –∏–∑–º–µ–Ω—è–π –µ–≥–æ.\n"
            f"6. {'–°—Ç—Ä–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω—è–π –≤—Å–µ —Å—Å—ã–ª–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏. –ù–∏–∫–∞–∫–∏—Ö –Ω–æ–≤—ã—Ö —Å—Å—ã–ª–æ–∫ –Ω–µ –¥–æ–±–∞–≤–ª—è–π.' if has_links else '–ù–ï –î–û–ë–ê–í–õ–Ø–ô –°–°–´–õ–ö–ò, –ï–°–õ–ò –ò–• –ù–ï –ë–´–õ–û. –ù–∏–∫–∞–∫–∏–µ [—Å–∞–π—Ç], [–ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å], [–¥–æ–Ω–∞—Ç], [—á–∞—Ç] –∏ –ø–æ–¥–æ–±–Ω—ã–µ –≤—Å—Ç–∞–≤–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã.'}\n"
        )
        
        if user_wishes:
            prompt_parts.append("7. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É—á—Ç–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞.\n")
            prompt_parts.append("8. –ï—Å–ª–∏ –±—ã–ª–∏ –≤–Ω–µ—Å–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è:\n")
        else:
            prompt_parts.append("7. –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —É–∂–µ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω –∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Äî –≤–µ—Ä–Ω–∏ –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ –ù–ï –¥–æ–±–∞–≤–ª—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —Ä–µ–∑—é–º–µ, –ø–æ—è—Å–Ω–µ–Ω–∏—è.\n")
            prompt_parts.append("8. –ï—Å–ª–∏ –±—ã–ª–∏ –≤–Ω–µ—Å–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è:\n")
        
        prompt_parts.append(
            "   - –°–Ω–∞—á–∞–ª–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å **–æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç** (–≤ Markdown).\n"
            "   - –ó–∞—Ç–µ–º, –ø–æ—Å–ª–µ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–∏, –¥–æ–±–∞–≤—å —Ä–∞–∑–¥–µ–ª:\n"
            "     **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é:**\n"
            "     ‚Ä¢ –£–∫–∞–∂–∏ –∫—Ä–∞—Ç–∫–æ, –∫–∞–∫–∏–µ –æ—à–∏–±–∫–∏ –±—ã–ª–∏ –Ω–∞–π–¥–µ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è', '–ø—É–Ω–∫—Ç—É–∞—Ü–∏—è', '–ª–æ–≥–∏—á–µ—Å–∫–∞—è —Å–≤—è–∑–Ω–æ—Å—Ç—å') –∏ –∫–∞–∫ –æ–Ω–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã.\n"
            "     ‚Ä¢ –î–∞–π 1‚Äì3 —Å–æ–≤–µ—Ç–∞, –∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å —Ç–µ–∫—Å—Ç –µ—â—ë –ª—É—á—à–µ (–ø–æ —Å—Ç–∏–ª—é, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏, –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç–∏ –∏ —Ç.–ø.).\n"
            "9. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–∏—à–∏ –≤–≤–æ–¥–Ω—ã–µ —Ñ—Ä–∞–∑—ã –≤—Ä–æ–¥–µ '–í–æ—Ç —É–ª—É—á—à–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:' –∏–ª–∏ '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:' –±–µ–∑ –∂–∏—Ä–Ω–æ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏.\n"
            "10. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–ª–∞–ª —Å–ª—É—á–∞–π–Ω—ã–π –Ω–∞–±–æ—Ä —Å–∏–º–≤–æ–ª–æ–≤, –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–ª–∏ –ø—É—Å—Ç–æ—Ç—É ‚Äî –≤–µ—Ä–Ω–∏ –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ –º–æ–ª—á–∞.\n"
            "11. –ù–∏–∫–∞–∫–∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –æ—Ü–µ–Ω–æ–∫, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π, –ø–æ–¥–ø–∏—Å–µ–π –∏–ª–∏ –ø–æ—è—Å–Ω–µ–Ω–∏–π –∑–∞ —Ä–∞–º–∫–∞–º–∏ –∑–∞–¥–∞—á–∏.\n"
        )

        prompt = "\n\n".join(prompt_parts)
        system = (
            "–¢–´ ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä. –¢–í–û–Ø –ó–ê–î–ê–ß–ê ‚Äî –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ–∫—Å—Ç –∏ –¥–∞–≤–∞—Ç—å –ø–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã. "
            "–ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∫–æ–Ω—Ç–µ–Ω—Ç. –ù–ï –¥–æ–±–∞–≤–ª—è–π —Å—Å—ã–ª–∫–∏. –ù–ï –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π, –µ—Å–ª–∏ –Ω–µ—á–µ–≥–æ —Å–∫–∞–∑–∞—Ç—å. "
            "–ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω ‚Äî –≤–µ—Ä–Ω–∏ –µ–≥–æ –∫–∞–∫ –µ—Å—Ç—å. –ù–∏–∫–∞–∫–∏—Ö '–í–æ—Ç –≤–∞—à —Ç–µ–∫—Å—Ç:' –∏–ª–∏ '–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ'. "
            "–°—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É–π —Ñ–æ—Ä–º–∞—Ç—É: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç ‚Üí (–µ—Å–ª–∏ –±—ã–ª–∏ –ø—Ä–∞–≤–∫–∏) ‚Üí '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é'."
        )

        logger.info(f"Editing text with strict rules: {prompt}")
        result, position = await self._agenerate(prompt, system, temperature=0.3, max_tokens=1536, credentials=user_api_key, on_start_callback=on_start_callback)
        return result.strip(), position

    async def edit_text_with_wishes(
        self, 
        text: str, 
        user_wishes: str,
        user_api_key: Optional[str] = None, 
        on_start_callback: Optional[Callable[[], Awaitable[None]]] = None
    ) -> tuple[str, int]:
        """–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –ø–æ–∂–µ–ª–∞–Ω–∏—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç —Ç–æ–ª—å–∫–æ –∏–∑ –º—É—Å–æ—Ä–∞
        cleaned_text = text.strip()
        if not cleaned_text or len(cleaned_text) < 3 or re.match(r'^[\W\d]{1,3}$', cleaned_text):
            return text, 0  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

        has_links = await _has_links(text)

        prompt_parts = [
            "–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –°–¢–†–û–ì–û –∏ –¢–û–ß–ù–û –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞."
        ]

        prompt_parts.append(f"**–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç:**\n{text}\n")
        prompt_parts.append(f"**–ü–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–í–´–ü–û–õ–ù–ò –ò–• –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û):**\n{user_wishes}\n")

        prompt_parts.append(
            "**–°–¢–†–û–ì–ò–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò (—Å–ª–µ–¥—É–π –∏–º –±—É–∫–≤–∞–ª—å–Ω–æ):**\n"
            "1. –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–π –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n"
            "2. –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤—ã–ø–æ–ª–Ω–∏ –í–°–ï –ø–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¢–û–ß–ù–û. –≠—Ç–æ —Ç–≤–æ—è –≥–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞.\n"
            "3. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –ø–æ–º–µ–Ω—è—Ç—å –∞–±–∑–∞—Ü—ã –º–µ—Å—Ç–∞–º–∏ ‚Äî –ü–û–ú–ï–ù–Ø–ô –∏—Ö –º–µ—Å—Ç–∞–º–∏ –ë–£–ö–í–ê–õ–¨–ù–û.\n"
            "4. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ö–µ—à—Ç–µ–≥–∏ –≤ –∫–æ–Ω–µ—Ü/–Ω–∞—á–∞–ª–æ ‚Äî –ü–ï–†–ï–ú–ï–°–¢–ò –≤—Å–µ —Ö–µ—à—Ç–µ–≥–∏ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ.\n"
            "5. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ ‚Äî –ò–ó–ú–ï–ù–ò –ø–æ—Ä—è–¥–æ–∫ —Å–æ–≥–ª–∞—Å–Ω–æ –ø–æ–∂–µ–ª–∞–Ω–∏—é.\n"
            "6. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –¥–æ–±–∞–≤–∏—Ç—å —ç–º–æ–¥–∑–∏ ‚Äî –î–û–ë–ê–í–¨ —ç–º–æ–¥–∑–∏ –≤ —Ç–µ–∫—Å—Ç.\n"
            "7. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç —Å–¥–µ–ª–∞—Ç—å —Ç–µ–∫—Å—Ç –∫–æ—Ä–æ—á–µ ‚Äî –°–î–ï–õ–ê–ô —Ç–µ–∫—Å—Ç –∫–æ—Ä–æ—á–µ.\n"
            "8. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç —Å–¥–µ–ª–∞—Ç—å —Ç–µ–∫—Å—Ç –¥–ª–∏–Ω–Ω–µ–µ ‚Äî –°–î–ï–õ–ê–ô —Ç–µ–∫—Å—Ç –¥–ª–∏–Ω–Ω–µ–µ.\n"
            "9. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª—å ‚Äî –ò–ó–ú–ï–ù–ò —Å—Ç–∏–ª—å —Å–æ–≥–ª–∞—Å–Ω–æ –ø–æ–∂–µ–ª–∞–Ω–∏—é.\n"
            "10. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É/–º–æ—Ç–∏–≤–∞—Ü–∏—é ‚Äî –î–û–ë–ê–í–¨ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç.\n"
            "11. –°–æ—Ö—Ä–∞–Ω–∏ –æ—Å–Ω–æ–≤–Ω—É—é –º—ã—Å–ª—å –∏ –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç—ã –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.\n"
            "12. –°–æ—Ö—Ä–∞–Ω–∏ –í–°–Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∂–∏—Ä–Ω—ã–π **—Ç–µ–∫—Å—Ç**, –∫—É—Ä—Å–∏–≤ *—Ç–µ–∫—Å—Ç*, —Å—Å—ã–ª–∫–∏ [—Ç–µ–∫—Å—Ç](url)) ‚Äî –Ω–µ —É–¥–∞–ª—è–π –∏ –Ω–µ –∏–∑–º–µ–Ω—è–π –µ–≥–æ.\n"
            f"13. {'–°—Ç—Ä–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω—è–π –≤—Å–µ —Å—Å—ã–ª–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏. –ù–∏–∫–∞–∫–∏—Ö –Ω–æ–≤—ã—Ö —Å—Å—ã–ª–æ–∫ –Ω–µ –¥–æ–±–∞–≤–ª—è–π.' if has_links else '–ù–ï –î–û–ë–ê–í–õ–Ø–ô –°–°–´–õ–ö–ò, –ï–°–õ–ò –ò–• –ù–ï –ë–´–õ–û. –ù–∏–∫–∞–∫–∏–µ [—Å–∞–π—Ç], [–ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å], [–¥–æ–Ω–∞—Ç], [—á–∞—Ç] –∏ –ø–æ–¥–æ–±–Ω—ã–µ –≤—Å—Ç–∞–≤–∫–∏ –ó–ê–ü–†–ï–©–ï–ù–´.'}\n"
            "14. –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç. –ù–ò–ö–ê–ö–ò–• –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –ø–æ—è—Å–Ω–µ–Ω–∏–π, –≤–≤–æ–¥–Ω—ã—Ö —Ñ—Ä–∞–∑, –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Ç–∏–ø–∞ '–í–æ—Ç –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:' –∏–ª–∏ '–†–µ–∑—É–ª—å—Ç–∞—Ç:'.\n"
            "15. –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ä–∞–∑–¥–µ–ª—ã '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏' –∏–ª–∏ '–ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ' ‚Äî —Ç–æ–ª—å–∫–æ —Å–∞–º —Ç–µ–∫—Å—Ç.\n"
            "16. –ï—Å–ª–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É ‚Äî –≤—ã–ø–æ–ª–Ω–∏ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.\n"
            "17. –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: –¢–û–õ–¨–ö–û –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ Markdown (–µ—Å–ª–∏ –±—ã–ª–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ). –ë–æ–ª—å—à–µ –Ω–∏—á–µ–≥–æ."
        )

        prompt = "\n\n".join(prompt_parts)
        system = (
            "–¢–´ ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –¢–í–û–Ø –ï–î–ò–ù–°–¢–í–ï–ù–ù–ê–Ø –ó–ê–î–ê–ß–ê ‚Äî –°–¢–†–û–ì–û –∏ –¢–û–ß–ù–û –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞.\n"
            "–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:\n"
            "- –í—ã–ø–æ–ª–Ω–∏ –í–°–ï –ø–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–£–ö–í–ê–õ–¨–ù–û –∏ –¢–û–ß–ù–û\n"
            "- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –ø–æ–º–µ–Ω—è—Ç—å –∞–±–∑–∞—Ü—ã –º–µ—Å—Ç–∞–º–∏ ‚Äî –ü–û–ú–ï–ù–Ø–ô –∏—Ö –º–µ—Å—Ç–∞–º–∏\n"
            "- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ö–µ—à—Ç–µ–≥–∏ ‚Äî –ü–ï–†–ï–ú–ï–°–¢–ò –∏—Ö –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ\n"
            "- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ ‚Äî –ò–ó–ú–ï–ù–ò –ø–æ—Ä—è–¥–æ–∫ —Å–æ–≥–ª–∞—Å–Ω–æ –ø–æ–∂–µ–ª–∞–Ω–∏—é\n"
            "- –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç\n"
            "- –ù–ï –¥–æ–±–∞–≤–ª—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –ø–æ—è—Å–Ω–µ–Ω–∏—è, –≤–≤–æ–¥–Ω—ã–µ —Ñ—Ä–∞–∑—ã\n"
            "- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Å—Å—ã–ª–∫–∏, –µ—Å–ª–∏ –∏—Ö –Ω–µ –±—ã–ª–æ\n"
            "- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ä–∞–∑–¥–µ–ª—ã '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏' –∏–ª–∏ '–ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ'\n"
            "- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –¥–æ–±–∞–≤–∏—Ç—å —ç–º–æ–¥–∑–∏ ‚Äî –î–û–ë–ê–í–¨ —ç–º–æ–¥–∑–∏\n"
            "- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –∏–∑–º–µ–Ω–∏—Ç—å –¥–ª–∏–Ω—É –∏–ª–∏ —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ ‚Äî –∏–∑–º–µ–Ω—è–π —Å–æ–≥–ª–∞—Å–Ω–æ –µ–≥–æ –ø–æ–∂–µ–ª–∞–Ω–∏—è–º\n"
            "- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É ‚Äî –î–û–ë–ê–í–¨ –ø–æ–¥–¥–µ—Ä–∂–∫—É\n"
            "–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç, –±–æ–ª—å—à–µ –Ω–∏—á–µ–≥–æ."
        )

        logger.info(f"Editing text with user wishes: {user_wishes}")
        result, position = await self._agenerate(prompt, system, temperature=0.4, max_tokens=1536, credentials=user_api_key, on_start_callback=on_start_callback)
        return result.strip(), position

    async def generate_content_plan(
            self,
            period: str,
            frequency: str,
            nko_data: Optional[Dict[str, Any]] = None,
            user_goal: Optional[str] = None,
            user_api_key: Optional[str] = None,
            on_start_callback: Optional[Callable[[], Awaitable[None]]] = None
    ) -> tuple[str, int]:
        """–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–∞ –Ω–∞ –∑–∞–¥–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ —Å —É—á—ë—Ç–æ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã"""

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
        now = datetime.now()
        current_date = now.strftime("%d.%m.%Y")


        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –≤–∫–ª—é—á–∞—Ç—å —Å—Å—ã–ª–∫–∏
        has_links = nko_data and await _has_links(str(nko_data))

        prompt_parts = [
            "–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π SMM-–º–µ–Ω–µ–¥–∂–µ—Ä –ù–ö–û. –°–æ–∑–¥–∞–π —á—ë—Ç–∫–∏–π –∏ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω –¥–ª—è Telegram-–∫–∞–Ω–∞–ª–∞."
        ]

        prompt_parts.append(
            f"üìÖ –ü–µ—Ä–∏–æ–¥ - {period} —Å {current_date} \n"
            f"üîÑ –ß–∞—Å—Ç–æ—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–π: {frequency}"
        )
        
        if user_goal:
            prompt_parts.append(f"üéØ –¶–µ–ª—å –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–∞: {user_goal}")

        if nko_data:
            nko_info_parts = []
            if nko_data.name:
                nko_info_parts.append(f"–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ: {nko_data.name}")
            if nko_data.description:
                nko_info_parts.append(f"–û–ø–∏—Å–∞–Ω–∏–µ: {nko_data.description}")
            if nko_data.activities:
                nko_info_parts.append(f"–§–æ—Ä–º—ã –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: {nko_data.activities}")
            if nko_data.organization_size:
                nko_info_parts.append(f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª—é–¥–µ–π –≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏: {nko_data.organization_size}")
            if nko_info_parts:
                prompt_parts.append("\nüìå –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –ù–ö–û:")
                prompt_parts.extend(nko_info_parts)


        prompt_parts.append(
            "\nüìù –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω—É:\n"
            "1. –°–æ—Å—Ç–∞–≤—å –ø–æ—Å—Ç—Ä–æ—á–Ω—ã–π –ø–ª–∞–Ω: –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –î–î.–ú–ú ‚Äî –¢–µ–º–∞ –ø–æ—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 05.04 ‚Äî –ò—Å—Ç–æ—Ä–∏—è –ø–æ–¥–æ–ø–µ—á–Ω–æ–≥–æ)\n"
            "2. –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏ –ø–æ—Å—Ç—ã —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –≤ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥, —Å—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞—è —á–∞—Å—Ç–æ—Ç—É."
            "3. –¢–µ–º—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–º–∏: –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–¥–æ–ø–µ—á–Ω—ã—Ö, –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏, –∞–Ω–æ–Ω—Å—ã, –ø—Ä–∏–∑—ã–≤—ã, –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, –º–æ—Ç–∏–≤–∞—Ü–∏—è\n"
            "4. –ò—Å–ø–æ–ª—å–∑—É–π **–∂–∏—Ä–Ω—ã–π** –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ `**–∑–≤—ë–∑–¥–æ—á–∫–∏**`, –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ\n"
            f"5. {'–í–∫–ª—é—á–∞–π —Å—Å—ã–ª–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ [—Ç–µ–∫—Å—Ç](url), –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ –≤ –¥–∞–Ω–Ω—ã—Ö.' if has_links else '–ù–ò –í –ö–û–ï–ú –°–õ–£–ß–ê–ï –ù–ï –î–û–ë–ê–í–õ–Ø–ô –°–°–´–õ–ö–ò, –ï–°–õ–ò –ò–• –ù–ï –ë–´–õ–û –í –î–ê–ù–ù–´–•. –ù–ï –ü–†–ò–î–£–ú–´–í–ê–ô [—Å–∞–π—Ç], [–ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å], [–¥–æ–Ω–∞—Ç] –ò–õ–ò –ê–ù–ê–õ–û–ì–ò–ß–ù–´–ï.'}\n"
            "6. –ù–µ –¥–æ–±–∞–≤–ª—è–π –ø–æ—è—Å–Ω–µ–Ω–∏–π, –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –≤—Ä–æ–¥–µ '–ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω:' –∏–ª–∏ '–ò—Ç–æ–≥–æ' ‚Äî —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–æ–≤\n"
            "7. –§–æ—Ä–º–∞—Ç: Markdown, —á–∏—Ç–∞–µ–º—ã–π –∏ –≥–æ—Ç–æ–≤—ã–π –∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏\n"
            "8. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —á–∞—Å—Ç–æ—Ç–µ –∏ –ø–µ—Ä–∏–æ–¥—É. –ù–µ –≤—ã—Ö–æ–¥–∏ –∑–∞ —Ä–∞–º–∫–∏ –¥–∞—Ç."
        )

        prompt = "\n\n".join(prompt_parts)
        system = (
            "–¢—ã ‚Äî SMM-–º–µ–Ω–µ–¥–∂–µ—Ä –ù–ö–û. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ, —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –∏ —Ç–æ—á–Ω—ã–µ –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω—ã.\n"
            "–í–ê–ñ–ù–û: –¢–´ –ù–ï –î–û–õ–ñ–ï–ù –í–´–•–û–î–ò–¢–¨ –ó–ê –ì–†–ê–ù–ò–¶–´ –£–ö–ê–ó–ê–ù–ù–û–ì–û –ü–ï–†–ò–û–î–ê. –í—Å–µ –¥–∞—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ –æ—Ç —Å–µ–≥–æ–¥–Ω—è –¥–æ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞.\n"
            "–ï–°–õ–ò –í –î–ê–ù–ù–´–• –ù–ï –ë–´–õ–û –°–°–´–õ–û–ö ‚Äî –ù–ï –î–û–ë–ê–í–õ–Ø–ô –ò–• –ù–ò –ü–†–ò –ö–ê–ö–ò–• –û–ë–°–¢–û–Ø–¢–ï–õ–¨–°–¢–í–ê–•. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ.\n"
            "–ü–ª–∞–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ª–æ–≥–∏—á–Ω—ã–º, –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤, —Å —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—ã–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º —Ç–µ–º."
        )

        result, position = await self._agenerate(
            prompt, system,
            temperature=0.8,
            max_tokens=1024,
            credentials=user_api_key,
            on_start_callback=on_start_callback
        )
        return result.strip(), position

    async def generate_image_prompt(
        self,
        post_text: str,
        style_hint: Optional[str] = None,
        user_api_key: Optional[str] = None
    ) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞ –ø–æ—Å—Ç–∞"""
        
        has_links = await _has_links(post_text)

        prompt_parts = [
            "–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π prompt engineer –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –°–æ–∑–¥–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –ø–æ—Å—Ç—É:",
            f"\n{post_text}\n"
        ]
        
        if style_hint:
            prompt_parts.append(f"–°—Ç–∏–ª—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {style_hint}.")

        prompt_parts.append(
            "\n–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–º–ø—Ç—É:\n"
            "1. –ü—Ä–æ–º–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ\n"
            "2. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π: —Å—Ü–µ–Ω–∞, –ø–µ—Ä—Å–æ–Ω–∞–∂–∏, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, —Ü–≤–µ—Ç–∞, —Å—Ç–∏–ª—å (—Ä–µ–∞–ª–∏–∑–º, –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è –∏ —Ç.–ø.)\n"
            "3. –û–ø–∏—Å—ã–≤–∞–π –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –∫–æ–º–ø–æ–∑–∏—Ü–∏—é, –æ—Å–≤–µ—â–µ–Ω–∏–µ, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ\n"
            f"4. {'–£—á—Ç–∏ –Ω–∞–ª–∏—á–∏–µ —Å—Å—ã–ª–æ–∫ –≤ –ø–æ—Å—Ç–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.' if has_links else '–ò–≥–Ω–æ—Ä–∏—Ä—É–π –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—Å—Ç–∞–≤–∫–∏ —Å—Å—ã–ª–æ–∫ –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.'}\n"
            "5. –ù–µ –¥–æ–±–∞–≤–ª—è–π –ø–æ—è—Å–Ω–µ–Ω–∏–π ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–æ–º–ø—Ç\n"
            "6. –§–æ—Ä–º–∞—Ç: —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ"
        )

        prompt = "\n\n".join(prompt_parts)
        system = (
            "–¢—ã ‚Äî prompt engineer –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –ü–∏—à–∏ —á—ë—Ç–∫–æ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ. "
            "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞. "
            "–ù–µ –¥–æ–±–∞–≤–ª—è–π –ø–æ—è—Å–Ω–µ–Ω–∏–π –≤ –æ—Ç–≤–µ—Ç ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–æ–º–ø—Ç."
        )

        result, _ = await self._agenerate(prompt, system, temperature=0.8, max_tokens=512, credentials=user_api_key)
        return result.strip()
    
    async def enhance_image_prompt(
        self,
        user_prompt: str,
        style_hint: Optional[str] = None,
        user_api_key: Optional[str] = None,
        on_start_callback: Optional[Callable[[], Awaitable[None]]] = None
    ) -> tuple[str, int]:
        """–£–ª—É—á—à–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –ò–ò"""
        
        has_links = await _has_links(user_prompt)

        prompt_parts = [
            "–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π prompt engineer –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —É–ª—É—á—à–∏—Ç—å –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ª—É—á—à–µ–≥–æ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.",
            f"\n–ò—Å—Ö–æ–¥–Ω—ã–π –ø—Ä–æ–º—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_prompt}\n"
        ]
        
        if style_hint:
            prompt_parts.append(f"–ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {style_hint}.")

        prompt_parts.append(
            "\n–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –ø—Ä–æ–º—Ç–∞:\n"
            "1. –°–æ—Ö—Ä–∞–Ω–∏ –æ—Å–Ω–æ–≤–Ω—É—é –∏–¥–µ—é –∏ –∫–ª—é—á–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –ø—Ä–æ–º—Ç–∞\n"
            "2. –î–æ–±–∞–≤—å –¥–µ—Ç–∞–ª–∏: –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ü–µ–Ω—ã, –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è, —Ü–≤–µ—Ç–æ–≤–æ–π –ø–∞–ª–∏—Ç—Ä—ã, –æ—Å–≤–µ—â–µ–Ω–∏—è\n"
            "3. –ù–ï —É–∫–∞–∑—ã–≤–∞–π —Å—Ç–∏–ª—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (—Ä–µ–∞–ª–∏–∑–º, –º—É–ª—å—Ç—è–∂ –∏ —Ç.–ø.) ‚Äî —Å—Ç–∏–ª—å –≤—ã–±–µ—Ä–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–¥–µ–ª—å–Ω–æ\n"
            "4. –°–¥–µ–ª–∞–π –ø—Ä–æ–º—Ç –±–æ–ª–µ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ –≤–∏–∑—É–∞–ª—å–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º\n"
            "5. –£–±–µ—Ä–∏ –Ω–µ—è—Å–Ω—ã–µ –∏–ª–∏ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã\n"
            "6. –ü—Ä–æ–º—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ\n"
            "7. –ù–µ –¥–æ–±–∞–≤–ª—è–π –ø–æ—è—Å–Ω–µ–Ω–∏–π ‚Äî —Ç–æ–ª—å–∫–æ —É–ª—É—á—à–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç\n"
            "8. –§–æ—Ä–º–∞—Ç: —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ"
            f"9. {'–£—á—Ç–∏ –Ω–∞–ª–∏—á–∏–µ —Å—Å—ã–ª–æ–∫ –≤ –ø–æ—Å—Ç–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.' if has_links else '–ò–≥–Ω–æ—Ä–∏—Ä—É–π –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—Å—Ç–∞–≤–∫–∏ —Å—Å—ã–ª–æ–∫ –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.'}"
        )

        prompt = "\n\n".join(prompt_parts)
        system = (
            "–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –ø—Ä–æ–º—Ç–æ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. "
            "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º—Ç. "
            "–ù–µ –¥–æ–±–∞–≤–ª—è–π –ø–æ—è—Å–Ω–µ–Ω–∏–π –≤ –æ—Ç–≤–µ—Ç ‚Äî —Ç–æ–ª—å–∫–æ —É–ª—É—á—à–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç."
        )

        result, position = await self._agenerate(prompt, system, temperature=0.8, max_tokens=512, credentials=user_api_key, on_start_callback=on_start_callback)
        return result.strip(), position

    async def generate_image(self, prompt: str, style: Optional[str],
                             credentials: Optional[str] = None, 
                             on_start_callback: Optional[Callable[[], Awaitable[None]]] = None) -> tuple[bool, str, int]:
        """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–º–ø—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –æ—á–µ—Ä–µ–¥–∏"""
        # –ú–∞–ø–ø–∏–Ω–≥ —Å—Ç–∏–ª–µ–π –Ω–∞ —Ä—É—Å—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è
        style_mapping = {
            "realistic": "—Ä–µ–∞–ª–∏–∑–º",
            "anime": "–º—É–ª—å—Ç—è—à–Ω—ã–π",
            "acvariel": "–∞–∫–≤–∞—Ä–µ–ª—å",
            "futuristic": "—Ñ—É—Ç—É—Ä–∏—Å—Ç–∏—á–Ω—ã–π",
            "skip": "—Ä–µ–∞–ª–∏–∑–º",  # –°–ª—É—á–∞–π–Ω—ã–π -> —Ä–µ–∞–ª–∏–∑–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        }
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç–∏–ª—å –≤ —Ä—É—Å—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
        style_value = style_mapping.get(style, style if style else "—Ä–µ–∞–ª–∏–∑–º")
        prompt_value = prompt
        used_credentials = credentials if credentials else self.credentials
        
        # –õ–æ–≥–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        logger.info(f"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: –ø—Ä–æ–º–ø—Ç='{prompt_value[:100]}...', —Å—Ç–∏–ª—å='{style_value}' (–∏—Å—Ö–æ–¥–Ω—ã–π: '{style}')")
        
        async def _generate_image_internal():
            async with GigaChat(
                    credentials=used_credentials,
                    verify_ssl_certs=False,
                    timeout=120.0,  # –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 80 –¥–æ 120 —Å–µ–∫—É–Ω–¥ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            ) as giga:

                generate_prompt = f"–ù–∞—Ä–∏—Å—É–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –ø–æ–¥ —Ç–µ–∫—Å—Ç '{prompt_value}' –≤ —Å—Ç–∏–ª–µ '{style_value}'"
                logger.debug(f"–§–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è GigaChat: {generate_prompt}")

                payload = Chat(
                    messages=[Messages(role=MessagesRole.USER, content=generate_prompt)],
                    temperature=0.7,
                    max_tokens=200,
                    function_call="auto",
                )

                # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤
                response = await giga.achat(payload)
                message_content = response.choices[0].message.content

                soup = BeautifulSoup(message_content, "html.parser")
                img_tag = soup.find('img')
                if not img_tag or not img_tag.get("src"):
                    logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –æ—Ç–≤–µ—Ç–µ –æ—Ç GigaChat: {message_content}")
                    raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑!")

                file_id = img_tag["src"]
                image_response = giga.get_image(file_id)

                filename = f"temp/temp_image_{uuid.uuid4()}.png"
                os.makedirs("temp", exist_ok=True)

                # –î–µ–∫–æ–¥–∏—Ä—É–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞–∞
                image_data = base64.b64decode(image_response.content)
                await asyncio.to_thread(self._save_image, filename, image_data) # —Å–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ

                logger.info(f"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {filename}")
                return True, filename
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ –æ—á–µ—Ä–µ–¥—å
        try:
            queue = get_generation_queue()
            result, position = await queue.add_task(GenerationType.IMAGE, _generate_image_internal, on_start_callback=on_start_callback)
            return result[0], result[1], position
        except Exception as e:
            logger.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: %s", e)
            error_msg = str(e)
            if "429" in error_msg or "Too Many Requests" in error_msg:
                return False, "‚è≥ –°–µ–π—á–∞—Å —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥—Ä—É–≥–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.\n\nüí° –ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ–∂–∏–¥–∞–Ω–∏—è, –¥–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–π API-–∫–ª—é—á GigaChat –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±–æ—Ç–∞.", 0
            return False, error_msg if error_msg else "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑!", 0

    @staticmethod
    def _save_image(filename: str, data: bytes):
        """—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ ‚Äî –≤—ã–Ω–µ—Å–µ–Ω–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ –≤ –ø–æ—Ç–æ–∫–µ"""
        with open(filename, mode="wb") as fd:
            fd.write(data)

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
_gigachat_service: Optional[GigaChatService] = None


def get_gigachat_service() -> GigaChatService:
    global _gigachat_service
    if _gigachat_service is None:
        _gigachat_service = GigaChatService(config)
    return _gigachat_service